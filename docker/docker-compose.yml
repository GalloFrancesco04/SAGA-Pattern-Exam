services:
  mssql-server:
    image: "mcr.microsoft.com/mssql/server:2019-latest"
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_PID: Developer
      MSSQL_SA_PASSWORD: p4ssw0rD
    ports:
      - 2433:1433
    volumes:
      - "mssql-server:/var/opt/mssql"
    healthcheck:
      test: ["CMD", "/opt/mssql-tools/bin/sqlcmd", "-S", "127.0.0.1", "-U", "sa", "-P", "p4ssw0rD", "-Q", "SELECT 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s

  zookeeper:
    image: confluentinc/cp-zookeeper:7.7.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  kafka:
    image: confluentinc/cp-kafka:7.7.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - '9092:9092'
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://host.docker.internal:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_ALLOW_EVERYONE_IF_NO_ACL_FOUND: "true"
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 5

  saas-orchestrator:
    build:
      context: ..
      dockerfile: microservices/Orchestrator/SaaS.Orchestrator.Api/Dockerfile
    image: saas-orchestrator:latest
    container_name: saas-orchestrator
    depends_on:
      - mssql-server
      - kafka
    ports:
      - "5013:8080"
    environment:
      TZ: Europe/Rome
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
    volumes:
      - "./config/saas-orchestrator-appsettings.json:/app/appsettings.json:ro"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  saas-billing:
    build:
      context: ..
      dockerfile: microservices/Billing/SaaS.Billing.Api/Dockerfile
    image: saas-billing:latest
    container_name: saas-billing
    depends_on:
      - mssql-server
      - kafka
    ports:
      - "5037:8080"
    environment:
      TZ: Europe/Rome
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
    volumes:
      - "./config/saas-billing-appsettings.json:/app/appsettings.json:ro"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  saas-provisioning:
    build:
      context: ..
      dockerfile: microservices/Provisioning/SaaS.Provisioning.Api/Dockerfile
    image: saas-provisioning:latest
    container_name: saas-provisioning
    depends_on:
      - mssql-server
      - kafka
    ports:
      - "5148:8080"
    environment:
      TZ: Europe/Rome
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
    volumes:
      - "./config/saas-provisioning-appsettings.json:/app/appsettings.json:ro"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  saas-notification:
    build:
      context: ..
      dockerfile: microservices/Notification/SaaS.Notification.Api/Dockerfile
    image: saas-notification:latest
    container_name: saas-notification
    depends_on:
      - mssql-server
      - kafka
    ports:
      - "5214:8080"
    environment:
      TZ: Europe/Rome
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
    volumes:
      - "./config/saas-notification-appsettings.json:/app/appsettings.json:ro"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  mssql-server:
